/*! USI Fiber - v0.0.1 - 2013-07-26
* https://github.com/MinnPost/minnpost-usi-fiber
* Copyright (c) 2013 MinnPost; Licensed MIT */

var mpApps=mpApps||{};_.mixin({formatNumber:function(a,b){b=_.isUndefined(b)?2:b;var c=/(\d+)(\d{3})/;for(split=a.toFixed(b).toString().split(".");c.test(split[0]);)split[0]=split[0].replace(c,"$1,$2");return b?split[0]+"."+split[1]:split[0]},formatCurrency:function(a){return"$"+_.formatNumber(a,2)},formatPercent:function(a){return _.formatNumber(100*a,1)+"%"},formatPercentChange:function(a){return(a>0?"+":"")+_.formatPercent(a)}}),"undefined"!=typeof Backbone&&!_.isUndefined($.jsonp)&&_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)}),function(a){var b;mpApps["minnpost-usi-fiber"]=b=function(){function b(b){this.options=_.extend(this.defaultOptions,b),this.$el=a(this.options.el)}return b.prototype.defaultOptions={dataPath:"./data/",jsonpProxy:"http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url="},b.prototype.templates={},b.prototype.getTemplate=function(b,c,d){var e=this,f="js/templates/"+b+".html";d=d||app,_.isUndefined(this.templates[f])?a.ajax({url:f,method:"GET",async:!1,contentType:"text",success:function(a){e.templates[f]=_.template(a),c.apply(d,[e.templates[f]])}}):c.apply(d,[this.templates[f]])},b.prototype.template=function(a){var b="js/templates/"+a+".html";return this.templates[b]},b.prototype.data={},b.prototype.getLocalData=function(b){var c=this,d=this.options.jsonpProxy,e=!1,f=[];return b=_.isArray(b)?b:[b],this.options&&0===this.options.dataPath.indexOf("http")&&(e=!0),_.each(b,function(b){var g;_.isUndefined(c.data[b])&&(g=e?a.jsonp({url:d+encodeURI(c.options.dataPath+b+".json")}):a.getJSON(c.options.dataPath+b+".json"),a.when(g).done(function(a){c.data[b]=a}),f.push(g))}),a.when.apply(a,f)},b.prototype.getRemoteData=function(b){return this.options.remoteProxy?(b.url=b.url+"&callback=proxied_jqjsp",b.url=app.options.remoteProxy+encodeURIComponent(b.url),b.callback="proxied_jqjsp",b.cache=!0):b.url=b.url+"&callback=?",a.jsonp(b)},b.prototype.start=function(){},b}()}(jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-usi-fiber"]=this.mpApp["minnpost-usi-fiber"]||{},this.mpApp["minnpost-usi-fiber"].templates=this.mpApp["minnpost-usi-fiber"].templates||{},this.mpApp["minnpost-usi-fiber"].templates["js/templates/template-application.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div id="fiber-map">\n</div>\n\n<div class="footnote-container">\n</div>';return __p},this.mpApp["minnpost-usi-fiber"].templates["js/templates/template-footnote.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="footnote">\n  <p>Code, techniques, and data on <a href="https://github.com/MinnPost/minnpost-usi-fiber" target="_blank">Github</a>.</p>\n</div>';return __p},this.mpApp["minnpost-usi-fiber"].templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>';return __p},this.mpApp["minnpost-usi-fiber"].templates["js/templates/template-map-label.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="map-label-inner-container">\n  <h4>'+(null==(__t=street)?"":__t)+" <br /> "+(null==(__t=numbers)?"":__t)+"</h4>\n  Status: "+(null==(__t=status)?"":__t)+"\n  \n  ","live"==status&&(__p+="\n    <br />At capacity: "+(null==(__t=capacity?"Yes":"No")?"":__t)+"\n  "),__p+="\n</div>";return __p},function(a){a.prototype.defaultMapStyle={color:"#AC5415",weight:3,opacity:.65},a.prototype.startTemplates=function(a,b){this.getTemplate("template-application",function(){this.getTemplate("template-footnote",function(){this.getTemplate("template-loading",function(){this.getTemplate("template-map-label",function(){a.apply(b,[])},this)},this)},this)},this)},a.prototype.start=function(){var a=this;this.startTemplates(function(){this.$el.html(this.template("template-application")({})),this.$el.find(".footnote-container").html(this.template("template-footnote")({})),this.getLocalData("usi-fiber.geo").done(function(){a.fiberJSON=arguments[0],a.makeMap()})},this)},a.prototype.makeMap=function(){var a=this,b=new L.tileLayer("http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png");this.map=new L.map("fiber-map"),this.map.setView([44.98,-93.2636],12),this.map.attributionControl.setPrefix(!1),this.map.addLayer(b),this.LabelControl=this.LabelControl||L.Control.extend({options:{position:"topright"},onAdd:function(){var a=L.DomUtil.create("div","map-label-container");return a}}),this.map.addControl(new this.LabelControl),this.$el.find(".map-label-container").hide(),this.fiberJSONLayer=L.geoJson(this.fiberJSON,{style:function(b){var c=_.clone(a.defaultMapStyle);return"live"===b.properties.status&&(c.color="#6DAC15",1===b.properties.capacity&&(c.color="#ACA015")),c},onEachFeature:function(b,c){c.on({mouseover:function(b){var c=b.target,d=_.clone(c.options);a.$el.find(".map-label-container").html(a.template("template-map-label")(c.feature.properties)).show(),d.opacity=.9,c.setStyle(d),c.bringToFront()},mouseout:function(b){a.$el.find(".map-label-container").hide(),a.fiberJSONLayer.resetStyle(b.target)},click:function(b){a.map.fitBounds(b.target.getBounds())}})}}),this.map.addLayer(this.fiberJSONLayer)}}(mpApps["minnpost-usi-fiber"],jQuery);
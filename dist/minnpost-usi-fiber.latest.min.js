/*! USI Fiber - v0.0.1 - 2013-09-04
* https://github.com/MinnPost/minnpost-usi-fiber
* Copyright (c) 2013 MinnPost; Licensed MIT */

var mpApps=mpApps||{},mpTemplates=mpTemplates||{};mpTemplates["minnpost-usi-fiber"]=mpTemplates["minnpost-usi-fiber"]||{},_.mixin({formatNumber:function(a,b){b=_.isUndefined(b)?2:b;var c=/(\d+)(\d{3})/;for(split=a.toFixed(b).toString().split(".");c.test(split[0]);)split[0]=split[0].replace(c,"$1,$2");return b?split[0]+"."+split[1]:split[0]},formatCurrency:function(a){return"$"+_.formatNumber(a,2)},formatPercent:function(a){return _.formatNumber(100*a,1)+"%"},formatPercentChange:function(a){return(a>0?"+":"")+_.formatPercent(a)}}),"undefined"!=typeof Backbone&&!_.isUndefined($.jsonp)&&_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)}),function(a){var b,c=mpTemplates["minnpost-usi-fiber"]||{};mpApps["minnpost-usi-fiber"]=b=function(){function b(b){this.options=_.extend(this.defaultOptions,b),this.$el=a(this.options.el)}return b.prototype.defaultOptions={dataPath:"./data/",jsonpProxy:"http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url="},b.prototype.templates=c,b.prototype.getTemplate=function(b,c,d){var e=this,f="js/templates/"+b+".html";d=d||app,_.isUndefined(this.templates[f])?a.ajax({url:f,method:"GET",async:!1,contentType:"text",success:function(a){e.templates[f]=_.template(a),c.apply(d,[e.templates[f]])}}):c.apply(d,[this.templates[f]])},b.prototype.template=function(a){var b="js/templates/"+a+".html";return this.templates[b]},b.prototype.data={},b.prototype.getLocalData=function(b){var c=this,d=this.options.jsonpProxy,e=!1,f=[];return b=_.isArray(b)?b:[b],this.options&&0===this.options.dataPath.indexOf("http")&&(e=!0),_.each(b,function(b){var g;_.isUndefined(c.data[b])&&(g=e?a.jsonp({url:d+encodeURI(c.options.dataPath+b+".json")}):a.getJSON(c.options.dataPath+b+".json"),a.when(g).done(function(a){c.data[b]=a}),f.push(g))}),a.when.apply(a,f)},b.prototype.getRemoteData=function(b){return this.options.remoteProxy?(b.url=b.url+"&callback=proxied_jqjsp",b.url=app.options.remoteProxy+encodeURIComponent(b.url),b.callback="proxied_jqjsp",b.cache=!0):b.url=b.url+"&callback=?",a.jsonp(b)},b.prototype.start=function(){},b}()}(jQuery),this.mpTemplates=this.mpTemplates||{},this.mpTemplates["minnpost-usi-fiber"]=this.mpTemplates["minnpost-usi-fiber"]||{},this.mpTemplates["minnpost-usi-fiber"]["js/templates/template-application.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="message-container"></div>\n\n<a href="#" class="reset-map-view"></a>\n\n<div id="fiber-map">\n</div>\n\n<div class="legend cf">\n  <div class="legend-item live">\n    <div><span class="swatch"></span> <strong>Live</strong>: The fiber network has been laid and residents are able to sign up for service.</div>\n  </div>\n\n  <div class="legend-item live-no-capcity">\n    <div><span class="swatch"></span> <strong>Live (capacity reached)</strong>: The fiber network has been laid but capacity reached; no new installations are available at this time unless the building is already wired.</div>\n  </div>\n\n  <div class="legend-item pending">\n    <div><span class="swatch"></span> <strong>Pending</strong>: The network is still under construction and should be available in the near future; most of the dates for completion are for Fall of 2013.</div>\n  </div>\n</div>\n\n<div class="footnote-container">\n</div>';return __p},this.mpTemplates["minnpost-usi-fiber"]["js/templates/template-footnote.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="footnote">\n  <p>Fiber data collected from the <a href="http://fiber.usinternet.com/" target="_blank">US Internet Fiber site</a>; for up-to-date data concerning US Internet Fiber, please consult their website or with the company itself.  Some map data &copy; OpenStreetMap contributors; licensed under the <a href="http://www.openstreetmap.org/copyright" target="_blank">Open Data Commons Open Database License</a>.  Some map design &copy; MapBox; licensed according to the <a href="http://mapbox.com/tos/" target="_blank">MapBox Terms of Service</a>.  Other code, techniques, and data can be found on <a href="https://github.com/MinnPost/minnpost-usi-fiber" target="_blank">Github</a>.</p>\n</div>';return __p},this.mpTemplates["minnpost-usi-fiber"]["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>';return __p},this.mpTemplates["minnpost-usi-fiber"]["js/templates/template-map-label.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="map-label-inner-container">\n  <h4>'+(null==(__t=name)?"":__t)+"</h4>\n  <p><strong>"+(null==(__t=description)?"":__t)+"</strong></p>\n\n  <p>\n    Phase: "+(null==(__t=phase)?"":__t)+"<br />\n    Status: "+(null==(__t=status)?"":__t)+"\n    ","live"==status&&(__p+="\n      <br />At capacity: "+(null==(__t=capacity?"Yes":"No")?"":__t)+"\n    "),__p+="\n\n    ","undefined"!=typeof complete&&_.isString(complete)&&(__p+="\n      <br />Estimated completion: "+(null==(__t=complete)?"":__t)+"\n    "),__p+="\n  </p>\n</div>";return __p},function(a,b){a.prototype.colors={live:"#6DAC15",capacity:"#ACA015",pending:"#AC5415"},a.prototype.defaultMapStyle={color:a.prototype.colors.pending,weight:1,opacity:.85,fillOpacity:.5},a.prototype.startTemplates=function(a,b){this.getTemplate("template-application",function(){this.getTemplate("template-footnote",function(){this.getTemplate("template-loading",function(){this.getTemplate("template-map-label",function(){a.apply(b,[])},this)},this)},this)},this)},a.prototype.start=function(){var a=this;this.startTemplates(function(){this.$el.html(this.template("template-application")({})),this.$el.find(".footnote-container").html(this.template("template-footnote")({})),this.$el.find(".message-container").html(this.template("template-loading")({})).slideDown(),this.getLocalData("usi-fiber.geo").done(function(){a.fiberJSON=arguments[0],a.makeMap(),a.$el.find(".message-container").slideUp(function(){b(this).html("")})})},this)},a.prototype.makeMap=function(){var a=this,b=new L.tileLayer("//{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png");this.map=new L.map("fiber-map",{zoom:10,center:[44.98,-93.2636],minZoom:10,maxZoom:18}),this.map.attributionControl.setPrefix(!1),this.map.addLayer(b),this.LabelControl=this.LabelControl||L.Control.extend({options:{position:"topright"},onAdd:function(){var a=L.DomUtil.create("div","map-label-container");return a}}),this.map.addControl(new this.LabelControl),this.$el.find(".map-label-container").hide(),this.fiberJSONLayer=L.geoJson(this.fiberJSON,{style:function(b){var c=_.clone(a.defaultMapStyle);return"live"===b.properties.status&&(c.color=a.colors.live,b.properties.capacity===!0&&(c.color=a.colors.capacity)),c.weight=.05*a.map.getZoom(),c},onEachFeature:function(b,c){c.on({mouseover:function(b){var c=b.target,d=_.clone(c.options);a.$el.find(".map-label-container").html(a.template("template-map-label")(c.feature.properties)).show(),d.opacity=.95,d.fillOpacity=.85,c.setStyle(d),c.bringToFront()},mouseout:function(b){a.$el.find(".map-label-container").hide(),a.fiberJSONLayer.resetStyle(b.target)},click:function(b){a.map.fitBounds(b.target.getBounds())}})}}),this.map.addLayer(this.fiberJSONLayer),this.map.on("zoomend",function(){_.each(a.fiberJSONLayer._layers,function(b){a.fiberJSONLayer.resetStyle(b)})}),this.map.fitBounds(this.fiberJSONLayer.getBounds()),this.$el.find(".live .swatch").css("background-color",this.colors.live),this.$el.find(".live-no-capcity .swatch").css("background-color",this.colors.capacity),this.$el.find(".pending .swatch").css("background-color",this.colors.pending),this.$el.find(".reset-map-view").text("Reset map view").on("click",this.$el,function(b){b.preventDefault(),a.map.fitBounds(a.fiberJSONLayer.getBounds())})}}(mpApps["minnpost-usi-fiber"],jQuery);